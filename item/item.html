<!--
    @parameters: mode, item, entity
-->

<index:>
    {{with @item as #item}}
        <view name="-{{@mode}}" inherit />
    {{/}}


<-text:>
    {{alert("TODO")}}

<!-- this is a little bit inconsistently named... maybe call this display and make html render the whole item? -->


<-html:>
    {{if decorationAttrs.length}}
        <view name="{{decorationAttrs[0].type}}" item="{{#item}}" attr="{{decorationAttrs[0]}}" da="{{displayAttr}}" mode="html">
            <view name="{{da.type}}" item="{{item}}" attr="{{da}}" mode="html" />
        </view>
    {{else}}
        <view name="{{displayAttr.type}}" item="{{#item}}" attr="{{displayAttr}}" inherit />
    {{/}}



<-htmlY:>
    <view name="-decorate" inherit>
        <view name="{{displayAttr.type}}" item="{{#item}}" attr="{{displayAttr}}" inherit />
    </view>

<-decorate:>
    {{if decorationAttrs.length}}
        <view name="{{decorationAttrs[0].type}}" item="{{#item}}" attr="{{decorationAttrs[0]}}" inherit>
            {{@content}}
        </view>
    {{else}}
        {{@content}}
    {{/}}



<-htmlX:>
    <view name="-decorateRec" current="{{0}}" inherit>
        <view name="{{displayAttr.type}}" item="{{#item}}" attr="{{displayAttr}}" inherit />
    </view>

<-decorateRec:>
    {{if decorationAttrs.length > @current}}
        <view name="-decorateRec" current="{{@current + 1}}" inherit>
            <view name="{{decorationAttrs[@current].type}}" item="{{#item}}" attr="{{decorationAttrs[@current]}}" inherit>
                {{@content}}
            </view>
        </view>
    {{else}}
        {{@content}}
    {{/}}


<-edit:>
    <form as="page.itemForm" role="form" class="well form-horizontal" on-submit="done(this)">
        {{each entity.attributes as #field}}
            {{if #field.i18n}}
                {{each $locale.supported as #loc}}
                    <fieldgroup id="{{#field.id}}_{{#loc}}" label="{{t($locale, entity.id + '.' + #field.id)}} ({{#loc}})">
                        <view id="{{#field.id}}_{{#loc}}" name="{{#field.type}}" mode="edit"
                            item="{{#item}}" attr="{{#field}}" loc="{{#loc}}" inherit />
                    </fieldgroup>
                {{/}}
            {{else}}
                <!-- this is called twice upon changing the input! WHY?? -->
                <!-- {{console.log("render field: ", #field, _page.item[#field.id])}} -->
                <fieldgroup id="{{#field.id}}" label="{{t($locale, entity.id + '.' + #field.id)}}">
                    <view id="{{#field.id}}" name="{{#field.type}}" mode="edit"
                        item="{{#item}}" attr="{{#field}}" inherit />
                </fieldgroup>
            {{/}}
        {{/each}}

        <div class="row">
            <div class="col-xs-12">
                <div class="pull-right">
                    <button type="submit" class="btn btn-primary">{{t($locale, 'actions.done')}}</button>
                </div>
            </div>
        </div>
    </form>


<!-- Arguments: id, label, type, value -->
<fieldgroup: element="fieldgroup">
    {{with @id as #id}} <!-- BUG in Derby parsing: "if !$validation.form[@id]" doesn't work! -->
        <div class="form-group {{if $validation.form[#id] === false}}has-error{{/}}">
            <label for="{{#id}}" class="col-sm-2 control-label">
                {{@label}}
            </label>
            <div class="col-md-10">
                {{@content}}
            </div>
        </div>
    {{/}}
